<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeMate Terminal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #0d1117;
            color: #e6edf3;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow: hidden;
            height: 100vh;
        }

        .terminal-container {
            width: 100%;
            height: 100vh;
            background: #0d1117;
            padding: 16px;
            padding-bottom: 80px; /* Space for fixed input */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }


        .terminal-output {
            background: #0d1117;
            color: #e6edf3;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-bottom: 8px;
            min-height: 400px;
            flex: 1;
            overflow-y: auto;
        }

        .terminal-input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #0d1117;
            border-top: 1px solid #21262d;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            z-index: 100;
        }

        .terminal-prompt {
            color: #58a6ff;
            margin-right: 8px;
            font-weight: 500;
        }

        .terminal-input {
            background: transparent;
            border: none;
            color: #e6edf3;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', monospace;
            font-size: 13px;
            outline: none;
            flex: 1;
            caret-color: #58a6ff;
        }

        .terminal-input::placeholder {
            color: #7d8590;
        }

        .status-bar {
            position: fixed;
            bottom: 60px;
            left: 0;
            right: 0;
            background: #161b22;
            border-top: 1px solid #21262d;
            padding: 4px 16px;
            font-size: 11px;
            color: #7d8590;
            display: flex;
            justify-content: space-between;
            z-index: 50;
        }

        .permission-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0d1117;
            color: #e6edf3;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .permission-content {
            max-width: 800px;
            text-align: center;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', monospace;
        }

        .ascii-banner {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', monospace;
            font-size: 10px;
            line-height: 1.1;
            color: #58a6ff;
            margin-bottom: 20px;
            white-space: pre;
            text-align: center;
        }

        .permission-text {
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .permission-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .permission-btn {
            background: #21262d;
            border: 1px solid #30363d;
            color: #e6edf3;
            padding: 8px 16px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', monospace;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 6px;
        }

        .permission-btn:hover {
            background: #30363d;
            border-color: #58a6ff;
        }

        .permission-btn.grant:hover {
            background: #238636;
            border-color: #238636;
        }

        .permission-btn.deny:hover {
            background: #da3633;
            border-color: #da3633;
        }


        .hidden {
            display: none;
        }

        .command-suggestions {
            position: fixed;
            bottom: 60px;
            left: 16px;
            right: 16px;
            background: #161b22;
            border: 1px solid #30363d;
            max-height: 200px;
            overflow-y: auto;
            z-index: 200;
            border-radius: 6px;
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #21262d;
            font-size: 12px;
        }

        .suggestion-item:hover {
            background: #21262d;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }


        @media (max-width: 768px) {
            .terminal-container {
                padding: 10px;
                padding-bottom: 100px; /* More space for mobile input */
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            
            .terminal-input-container {
                padding: 16px;
            }
            
            .command-suggestions {
                bottom: 80px;
                left: 10px;
                right: 10px;
            }
            
            .status-bar {
                bottom: 80px;
            }
        }
    </style>
</head>
<body>
    <!-- Permission Request Screen -->
    <div class="permission-screen" id="permission-screen">
        <div class="permission-content">
            <div class="ascii-banner">
  ╔═══════════════════════════════════════════════════════════════════════════════════════╗
  ║                                                                                       ║
  ║      ██████╗ ██████╗ ██████╗ ███████╗███╗   ███╗ █████╗ ████████╗███████╗          ║
  ║     ██╔════╝██╔═══██╗██╔══██╗██╔════╝████╗ ████║██╔══██╗╚══██╔══╝██╔════╝          ║
  ║     ██║     ██║   ██║██║  ██║█████╗  ██╔████╔██║███████║   ██║   █████╗            ║
  ║     ██║     ██║   ██║██║  ██║██╔══╝  ██║╚██╔╝██║██╔══██║   ██║   ██╔══╝            ║
  ║     ╚██████╗╚██████╔╝██████╔╝███████╗██║ ╚═╝ ██║██║  ██║   ██║   ███████╗          ║
  ║      ╚═════╝ ╚═════╝ ╚═════╝ ╚══════╝╚═╝     ╚═╝╚═╝  ╚═╝   ╚═╝   ╚══════╝          ║
  ║                                                                                       ║
  ║                           AI-Powered Terminal                                        ║
  ║                         CodeMate.ai Hackathon                                        ║
  ║                                                                                       ║
  ╚═══════════════════════════════════════════════════════════════════════════════════════╝
        </div>

            <div class="permission-text">
                <div style="border: 1px solid #58a6ff; padding: 20px; margin: 20px 0; background: #0d1117; border-radius: 8px;">
                    <div style="color: #58a6ff; font-weight: bold; margin-bottom: 15px; text-align: center; font-size: 16px;">
                        ┌─ System Initialization ─┐
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 13px; margin: 15px 0;">
                        <div style="padding: 8px; border-left: 3px solid #58a6ff; padding-left: 12px;">
                            <span style="color: #7d8590;">Platform:</span> 
                            <span style="color: #e6edf3;" id="platform-info">Detecting...</span>
                        </div>
                        <div style="padding: 8px; border-left: 3px solid #58a6ff; padding-left: 12px;">
                            <span style="color: #7d8590;">Runtime:</span> 
                            <span style="color: #e6edf3;">Python 3.x</span>
                        </div>
                        <div style="padding: 8px; border-left: 3px solid #58a6ff; padding-left: 12px;">
                            <span style="color: #7d8590;">User:</span> 
                            <span style="color: #e6edf3;" id="user-info">Current User</span>
                        </div>
                        <div style="padding: 8px; border-left: 3px solid #58a6ff; padding-left: 12px;">
                            <span style="color: #7d8590;">Memory:</span> 
                            <span style="color: #e6edf3;" id="memory-info">Available</span>
                        </div>
                        <div style="padding: 8px; border-left: 3px solid #38d9a9; padding-left: 12px;">
                            <span style="color: #7d8590;">AI Engine:</span> 
                            <span style="color: #38d9a9;">✓ Ready</span>
                        </div>
                        <div style="padding: 8px; border-left: 3px solid #38d9a9; padding-left: 12px;">
                            <span style="color: #7d8590;">Web UI:</span> 
                            <span style="color: #38d9a9;">✓ Active</span>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 30px 0;">
                    <div style="color: #f85149; font-weight: bold; font-size: 16px; margin-bottom: 10px;">
                        🔐 Permission Required
                    </div>
                    <div style="color: #e6edf3; font-size: 14px; margin-bottom: 8px;">
                        CodeMate Terminal needs access to your system to provide:
                    </div>
                    <div style="color: #7d8590; font-size: 12px; line-height: 1.6;">
                        • File system operations and navigation<br>
                        • System monitoring and process management<br>
                        • AI-powered natural language command processing<br>
                        • Real-time terminal emulation with full functionality
                    </div>
                </div>
            </div>
            
            <div class="permission-buttons">
                <button class="permission-btn grant" onclick="grantPermission()">
                    ✅ Yes, allow access
                </button>
                <button class="permission-btn deny" onclick="denyPermission()">
                    ❌ No, deny access
                </button>
            </div>
        </div>
    </div>


    <!-- Main Terminal -->
    <div class="terminal-container hidden" id="terminal-container">

        <div class="terminal-output" id="terminal-output"></div>
        
        <div class="terminal-input-container">
            <span class="terminal-prompt" id="terminal-prompt">user@codemate:~$</span>
            <input type="text" class="terminal-input" id="terminal-input" placeholder="Type command here..." autocomplete="off">
            <div class="command-suggestions hidden" id="command-suggestions"></div>
        </div>
    </div>

    <div class="status-bar">
        <span id="status-info">Ready</span>
        <span id="current-path">/</span>
    </div>

    <script>
        class CodeMateTerminal {
            constructor() {
                this.output = document.getElementById('terminal-output');
                this.input = document.getElementById('terminal-input');
                this.prompt = document.getElementById('terminal-prompt');
                this.suggestions = document.getElementById('command-suggestions');
                this.statusInfo = document.getElementById('status-info');
                this.currentPath = document.getElementById('current-path');
                this.commandHistory = [];
                this.historyIndex = -1;
                this.commandCount = 0;
                this.currentDir = '/';

                this.setupEventListeners();
                this.updatePrompt();
            }

            setupEventListeners() {
                this.input.addEventListener('keydown', (e) => this.handleKeyDown(e));
                this.input.addEventListener('input', (e) => this.handleInput(e));
                this.input.addEventListener('blur', () => this.hideSuggestions());
                
                // Keep focus on input for better UX
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.command-suggestions')) {
                        this.input.focus();
                    }
                });
                
                // Auto-focus when typing anywhere
                document.addEventListener('keydown', (e) => {
                    if (!e.target.matches('input, textarea') && e.key.length === 1) {
                        this.input.focus();
                    }
                });
            }

            handleKeyDown(e) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                    this.executeCommand();
                        break;
                    case 'ArrowUp':
                    e.preventDefault();
                    this.navigateHistory(-1);
                        break;
                    case 'ArrowDown':
                    e.preventDefault();
                    this.navigateHistory(1);
                        break;
                    case 'Tab':
                    e.preventDefault();
                    this.handleTabCompletion();
                        break;
                    case 'Escape':
                        this.hideSuggestions();
                        break;
                }
            }

            handleInput(e) {
                const value = e.target.value;
                if (value.length > 0) {
                    this.showSuggestions(value);
                } else {
                    this.hideSuggestions();
                }
            }

            async executeCommand() {
                const command = this.input.value.trim();
                if (!command) return;

                this.addToHistory(command);
                this.appendOutput(`${this.prompt.textContent} ${command}`);
                this.input.value = '';
                this.hideSuggestions();

                try {
                    const response = await fetch('/api/execute', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ command })
                    });

                    const data = await response.json();
                    
                    if (data.output) {
                        // Handle clear command
                        if (data.output.trim() === 'CLEAR_SCREEN') {
                            this.clearScreen();
                        } else {
                        this.appendOutput(data.output);
                        }
                    }
                    
                    if (data.error) {
                        this.appendOutput(`Error: ${data.error}`);
                    }

                    this.commandCount++;
                    this.updatePrompt(); // Refresh path after command
                    this.scrollToBottom(); // Ensure we scroll after command execution
                    
                } catch (error) {
                    this.appendOutput(`Connection error: ${error.message}`);
                }
            }

            appendOutput(text) {
                this.output.textContent += text + '\n';
                // Auto-scroll to bottom
                this.scrollToBottom();
            }

            scrollToBottom() {
                // Scroll the output container to bottom
                this.output.scrollTop = this.output.scrollHeight;
                
                // Also scroll the main container if needed
                const container = document.getElementById('terminal-container');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
                
                // Smooth scroll to bottom of page
                setTimeout(() => {
                    window.scrollTo({
                        top: document.body.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 100);
            }

            clearScreen() {
                // Clear the terminal output
                this.output.textContent = '';
                
                // Reset scroll position
                this.output.scrollTop = 0;
                
                // Focus input
                this.input.focus();
            }

            addToHistory(command) {
                this.commandHistory.unshift(command);
                if (this.commandHistory.length > 100) {
                    this.commandHistory.pop();
                }
                this.historyIndex = -1;
            }

            navigateHistory(direction) {
                if (this.commandHistory.length === 0) return;
                
                this.historyIndex += direction;
                
                if (this.historyIndex < 0) {
                    this.historyIndex = -1;
                    this.input.value = '';
                } else if (this.historyIndex >= this.commandHistory.length) {
                    this.historyIndex = this.commandHistory.length - 1;
                }
                
                if (this.historyIndex >= 0) {
                    this.input.value = this.commandHistory[this.historyIndex];
                }
            }

            handleTabCompletion() {
                const value = this.input.value;
                const suggestions = this.getSuggestions(value);
                
                if (suggestions.length === 1) {
                    this.input.value = suggestions[0];
                } else if (suggestions.length > 1) {
                    this.showSuggestions(value);
                }
            }

            getSuggestions(input) {
                const commands = [
                    'ls', 'cd', 'pwd', 'mkdir', 'rm', 'cp', 'mv', 'cat', 'grep', 'find',
                    'ps', 'top', 'free', 'df', 'du', 'which', 'whereis', 'echo',
                    'help', 'clear', 'history', 'exit', 'codemate', 'ask', 'translate'
                ];
                
                return commands.filter(cmd => cmd.startsWith(input.toLowerCase()));
            }

            showSuggestions(input) {
                const suggestions = this.getSuggestions(input);
                
                if (suggestions.length === 0) {
                    this.hideSuggestions();
                    return;
                }

                this.suggestions.innerHTML = suggestions
                    .map(suggestion => `<div class="suggestion-item" onclick="selectSuggestion('${suggestion}')">${suggestion}</div>`)
                    .join('');

                this.suggestions.classList.remove('hidden');
            }

            hideSuggestions() {
                this.suggestions.classList.add('hidden');
            }

            updatePrompt() {
                // Get current path from the server
                this.getCurrentPath().then(path => {
                    this.currentDir = path;
                    // Show full path in the prompt like a real terminal
                    this.prompt.textContent = `${path} ➜`;
                    this.updateStatus();
                });
            }

            async getCurrentPath() {
                try {
                    const response = await fetch('/api/execute', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ command: 'pwd' })
                    });
                    const data = await response.json();
                    return data.output ? data.output.trim() : '/';
                } catch (error) {
                    return '/';
                }
            }

            updateStatus() {
                this.statusInfo.textContent = `Commands: ${this.commandCount} | Status: Active`;
                this.currentPath.textContent = this.currentDir;
            }
        }

        // Global functions
        function selectSuggestion(suggestion) {
            document.getElementById('terminal-input').value = suggestion;
            document.getElementById('command-suggestions').classList.add('hidden');
        }


        function grantPermission() {
            document.getElementById('permission-screen').classList.add('hidden');
            startTerminal();
        }
        
        // Detect and update system info on permission screen
        function updatePermissionScreenInfo() {
            // Detect platform
            const platform = navigator.platform;
            const userAgent = navigator.userAgent;
            let platformInfo = 'Unknown';
            
            if (platform.indexOf('Win') > -1) {
                platformInfo = 'Windows';
            } else if (platform.indexOf('Mac') > -1) {
                platformInfo = 'macOS';
            } else if (platform.indexOf('Linux') > -1) {
                platformInfo = 'Linux';
            }
            
            // Update platform info if element exists
            const platformEl = document.getElementById('platform-info');
            if (platformEl) {
                platformEl.textContent = platformInfo;
            }
            
            // Update memory info
            if ('memory' in performance) {
                const memInfo = performance.memory;
                const totalMB = Math.round(memInfo.jsHeapSizeLimit / (1024 * 1024));
                const memoryEl = document.getElementById('memory-info');
                if (memoryEl) {
                    memoryEl.textContent = `${totalMB} MB Available`;
                }
            }
            
            // Update user info
            const userEl = document.getElementById('user-info');
            if (userEl) {
                userEl.textContent = 'Web User';
            }
        }

        function denyPermission() {
            alert('Access denied. CodeMate Terminal requires file system access to function.');
        }


        async function generateWelcomeMessage() {
            try {
                // Load system info from backend
                const response = await fetch('/api/welcome');
                const data = await response.json();
                const sysInfo = data.system_info || {};
                
                return `
  ╔═══════════════════════════════════════════════════════════════════════════════════════╗
  ║                                                                                       ║
  ║      ██████╗ ██████╗ ██████╗ ███████╗███╗   ███╗ █████╗ ████████╗███████╗             ║
  ║     ██╔════╝██╔═══██╗██╔══██╗██╔════╝████╗ ████║██╔══██╗╚══██╔══╝██╔════╝             ║
  ║     ██║     ██║   ██║██║  ██║█████╗  ██╔████╔██║███████║   ██║   █████╗               ║
  ║     ██║     ██║   ██║██║  ██║██╔══╝  ██║╚██╔╝██║██╔══██║   ██║   ██╔══╝               ║
  ║     ╚██████╗╚██████╔╝██████╔╝███████╗██║ ╚═╝ ██║██║  ██║   ██║   ███████╗             ║
  ║      ╚═════╝ ╚═════╝ ╚═════╝ ╚══════╝╚═╝     ╚═╝╚═╝  ╚═╝   ╚═╝   ╚══════╝             ║
  ║                                                                                       ║
  ║                       🚀 Terminal Session Active                                     ║
  ║                         CodeMate.ai Hackathon                                        ║
  ║                                                                                       ║
  ╚═══════════════════════════════════════════════════════════════════════════════════════╝

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ System Status ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Platform: ${sysInfo.platform || 'Unknown'}
Python: ${sysInfo.python_version || '3.x'}
User: ${sysInfo.user || 'Current User'}
Memory: ${sysInfo.memory_total || 'Available'}
CPU Cores: ${sysInfo.cpu_count || 'N/A'}
Architecture: ${sysInfo.architecture || 'Unknown'}

🚀 AVAILABLE FEATURES
✓ AI Natural Language Processing
✓ Real-time Command Execution
✓ Command History & Auto-completion
✓ System Monitoring
✓ File Operations
✓ CodeMate Integration
✓ Cross-platform Web Access

🤖 AI NATURAL LANGUAGE EXAMPLES
"create a folder called test"
"show me my files"
"what's my memory usage"
"create a new folder called demo and move file1.txt into it"
"find files called readme"
"search for function in *.py files"
"tell me about my system"
"debug this code file"

💡 Welcome to CodeMate Terminal! Here are some ways to get started:

🔹 Basic Commands: ls, pwd, cd, mkdir, rm, cat, cp, mv
🔹 System Info: ps, free, df, uptime, whoami, system_info
🔹 Natural Language: "create a folder called test", "show me my files"
🔹 AI Features: ask <question>, codemate <command>, translate <text>
🔹 Get Help: help, codemate status

Type any command or try natural language like "show me system info"
`;
            } catch (error) {
                console.error('Error loading welcome info:', error);
                return `
  ╔═══════════════════════════════════════════════════════════════════════════════════════╗
  ║                                                                                       ║
  ║      ██████╗ ██████╗ ██████╗ ███████╗███╗   ███╗ █████╗ ████████╗███████╗             ║
  ║     ██╔════╝██╔═══██╗██╔══██╗██╔════╝████╗ ████║██╔══██╗╚══██╔══╝██╔════╝             ║
  ║     ██║     ██║   ██║██║  ██║█████╗  ██╔████╔██║███████║   ██║   █████╗               ║
  ║     ██║     ██║   ██║██║  ██║██╔══╝  ██║╚██╔╝██║██╔══██║   ██║   ██╔══╝               ║
  ║     ╚██████╗╚██████╔╝██████╔╝███████╗██║ ╚═╝ ██║██║  ██║   ██║   ███████╗             ║
  ║      ╚═════╝ ╚═════╝ ╚═════╝ ╚══════╝╚═╝     ╚═╝╚═╝  ╚═╝   ╚═╝   ╚══════╝             ║
  ║                                                                                       ║
  ║                       🚀 Terminal Session Active                                      ║
  ║                         CodeMate.ai Hackathon                                         ║
  ║                                                                                       ║
  ╚═══════════════════════════════════════════════════════════════════════════════════════╝

CodeMate Terminal - Ready for Commands!

Type "help" for available commands or try natural language like "show me my files"
`;
            }
        }

        async function startTerminal() {
            document.getElementById('terminal-container').classList.remove('hidden');
            
            // Initialize terminal
            window.terminal = new CodeMateTerminal();
            
            // Display enhanced welcome message in terminal output
            const welcomeMessage = await generateWelcomeMessage();
            
            window.terminal.appendOutput(welcomeMessage);
            document.getElementById('terminal-input').focus();
            
            // Show initial path
            window.terminal.updatePrompt();
            
            // Ensure proper scrolling
            setTimeout(() => {
                window.terminal.scrollToBottom();
            }, 500);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Show permission screen first
            document.getElementById('permission-screen').classList.remove('hidden');
            
            // Update system info on permission screen
            updatePermissionScreenInfo();
        });
    </script>
</body>
</html>